---
title: "Data prep"
author: "BVD"
date: "6/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load data
```{r message=FALSE}
load("~/DFW7_1_19.RData")
DFW<-DFW7_1_19

library("cAIC4")
library("MuMIn")
library("lme4")
library("dummies")
library("dplyr")
```

ID LA courses
```{r}
DFW$LA<-0
DFW$LA[
  DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2172" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2178" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2182" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2188" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2192" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202B" & DFW$TERM=="2168" |
         DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204B" & DFW$TERM=="2172" | 
         DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204B" & DFW$TERM=="2178" | 
         DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204B" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204A" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="202B" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Ayars,Eric J" & DFW$Number=="204A" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Ayars,Eric J" & DFW$Number=="204A" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Ayars,Eric J" & DFW$Number=="204A" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="118" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="118" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2168" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="120" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Danner,Richard S" & DFW$Number=="118" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Danner,Richard S" & DFW$Number=="120" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Danner,Richard S" & DFW$Number=="118" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202A" & DFW$TERM=="2168" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202A" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202A" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202B" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202B" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202B" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="204B" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Newton,Mark H" & DFW$Number=="343" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Newton,Mark H" & DFW$Number=="343" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Hyewon K" & DFW$Number=="204B" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Hyewon K" & DFW$Number=="204B" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Hyewon K" & DFW$Number=="204B" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204A" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204C" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204C" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204C" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Strand,Krista L" & DFW$Number=="110" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Strand,Krista L" & DFW$Number=="110" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Tran,Cawa" & DFW$Number=="153" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Tran,Cawa" & DFW$Number=="153" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2168" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="321" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="350" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Zou,Xueli" & DFW$Number=="204A" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Zou,Xueli" & DFW$Number=="204A" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Joseph A" & DFW$Number=="202B" & DFW$TERM=="2192"
         ] <- 1

```

variables I care about
```{r}
DFW <- DFW[!is.na(DFW$Grade_Group),]
DFW$DFW<-ifelse(DFW$Grade_Group=="A",0,ifelse(DFW$Grade_Group=="B",0,ifelse(DFW$Grade_Group=="C",0,ifelse(DFW$Grade_Group=="D",0,ifelse(DFW$Grade_Group=="CR",0,1)))))
DFW$DDFW<-ifelse(DFW$Grade_Group=="A",0,ifelse(DFW$Grade_Group=="B",0,ifelse(DFW$Grade_Group=="C",0,ifelse(DFW$Grade_Group=="CR",0,1))))
names(DFW)[names(DFW)=="INSTRUCTOR1_NAME"] <- "instructor"
names(DFW)[names(DFW)=="FirstGeneration"] <- "firstgen"
names(DFW)[names(DFW)=="COURSE_ID"] <- "course"
names(DFW)[names(DFW)=="Ethnicity"] <- "race"
names(DFW)[names(DFW)=="GenderLabel"] <- "gender"
DFW$courID <- paste(DFW$Subject,DFW$course,DFW$Section,DFW$TERM, sep='')
reduced <- select(DFW, "TERM", "Subject", "Number","courID", "Section", "instructor","firstgen", "gender", "race", "dependent_income", "LA", "DDFW")
reduced <- as.data.frame(reduced)
```

creating dummy variables
```{r}
reduced <- dummy.data.frame(reduced, names=c("Number","race","firstgen","gender"),sep = "_")
reduced <- cbind(reduced, select(DFW, "Number","race","firstgen","gender"))

reduced$nonwhite <- ifelse(reduced$race=="White",0,1)
reduced$algebra <- ifelse(reduced$Number=="202A" |DFW$Number=="202B",1,0)
reduced$Female <- ifelse(reduced$gender=="Male",0,1)
```

subset data
```{r}
red_phys <- reduced[reduced$Subject=="PHYS",]
red_math <- reduced[reduced$Subject=="MATH",]
red_math_phys <- reduced[reduced$Subject=="PHYS" | reduced$Subject=="MATH",]
red_202A <- reduced[reduced$Number=="202A",]
red_202B <- reduced[reduced$Number=="202B",]
red_204A <- reduced[reduced$Number=="204A",]
red_204B <- reduced[reduced$Number=="204B",]
red_204C <- reduced[reduced$Number=="204C",]
red_introPhys <- reduced[reduced$Number=="204A" | reduced$Number=="202A",]
red_202_204 <- reduced[reduced$Number=="204A" | reduced$Number=="204B" | reduced$Number=="204C" | reduced$Number=="202A" | reduced$Number=="202B",]
```

Find best model (intro physics) (https://quantscience.rbind.io/2017/12/26/model-selection-for-multilevel-modeling/)
```{r}
#m_all <- (DDFW ~ firstgen*LA + Female*LA + nonwhite*LA + algebra*LA + (1|courID))
m_all <- (DDFW ~ firstgen*LA*Female*nonwhite + algebra + (1|courID))
options(na.action = "na.fail")
intro_mod_dredge <- glmer(m_all, data=red_introPhys,family = binomial)
intro_dredge <- dredge(intro_mod_dredge)
model.sel(intro_dredge, rank=AIC)
```

Find best model (between classes) (https://quantscience.rbind.io/2017/12/26/model-selection-for-multilevel-modeling/)
```{r}
m_courses <- (DDFW ~ Number_204B*LA + Number_204C*LA + Number_202A*LA + Number_202B*LA + (1|courID))
options(na.action = "na.fail")
phys_mod_dredge <- glmer(m_courses, data=red_202_204,family = binomial)
phys_dredge <- dredge(phys_mod_dredge)
model.sel(phys_dredge, rank=AIC)
```

running best model - intro phys
```{r}
intro_mod_final <- (DDFW ~ firstgen*LA + Female + nonwhite*LA + (1|courID))
intro_m_final <- glmer(intro_mod_final, data=red_introPhys,family = binomial)
summary(intro_m_final)
```

running best model - physics
```{r}
phys_mod_final <- (DDFW ~ Number_204B*LA + Number_204C*LA + Number_202A*LA + Number_202B*LA + (1|courID))
phys_m_final <- glmer(phys_mod_final, data=red_202_204,family = binomial)
summary(phys_m_final)
```

Probabilities - physics (https://sebastiansauer.github.io/convert_logit2prob/)
```{r}
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

logit2prob(-1.5)
logit2prob(-1.5)
mean(DFW_phys$DFW)
```
