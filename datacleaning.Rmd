---
title: "Data prep"
author: "BVD"
date: "6/23/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load data
```{r message=FALSE}
load("~/DFW7_1_19.RData")
DFW<-DFW7_1_19

library("hglm")
library("cAIC4")
```

ID LA courses
```{r}
DFW$LA<-0
DFW$LA[
  DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2172" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2178" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2182" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2188" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202A" & DFW$TERM=="2192" | 
         DFW$INSTRUCTOR1_NAME=="Brookes,David T" & DFW$Number=="202B" & DFW$TERM=="2168" |
         DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204B" & DFW$TERM=="2172" | 
         DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204B" & DFW$TERM=="2178" | 
         DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204B" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="204A" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Arpin,Paul C" & DFW$Number=="202B" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Ayars,Eric J" & DFW$Number=="204A" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Ayars,Eric J" & DFW$Number=="204A" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Ayars,Eric J" & DFW$Number=="204A" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="118" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="118" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2168" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="119" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Bailey,Paul L" & DFW$Number=="120" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Danner,Richard S" & DFW$Number=="118" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Danner,Richard S" & DFW$Number=="120" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Danner,Richard S" & DFW$Number=="118" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Herrera,Christine A" & DFW$Number=="120" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202A" & DFW$TERM=="2168" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202A" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202A" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202B" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202B" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="202B" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Lin,Yuhfen" & DFW$Number=="204B" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Newton,Mark H" & DFW$Number=="343" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Newton,Mark H" & DFW$Number=="343" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Hyewon K" & DFW$Number=="204B" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Hyewon K" & DFW$Number=="204B" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Hyewon K" & DFW$Number=="204B" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204A" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204C" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204C" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Petrova-Mayor,Anna I" & DFW$Number=="204C" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Strand,Krista L" & DFW$Number=="110" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Strand,Krista L" & DFW$Number=="110" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Tran,Cawa" & DFW$Number=="153" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Tran,Cawa" & DFW$Number=="153" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2168" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2172" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="141" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="321" & DFW$TERM=="2178" |
    DFW$INSTRUCTOR1_NAME=="Van Dusen,Benjamin C" & DFW$Number=="350" & DFW$TERM=="2182" |
    DFW$INSTRUCTOR1_NAME=="Zou,Xueli" & DFW$Number=="204A" & DFW$TERM=="2188" |
    DFW$INSTRUCTOR1_NAME=="Zou,Xueli" & DFW$Number=="204A" & DFW$TERM=="2192" |
    DFW$INSTRUCTOR1_NAME=="Pechkis,Joseph A" & DFW$Number=="202B" & DFW$TERM=="2192"
         ] <- 1

```

variables I care about
```{r}
DFW <- DFW[!is.na(DFW$Grade_Group),]
DFW$DFW<-ifelse(DFW$Grade_Group=="A",0,ifelse(DFW$Grade_Group=="B",0,ifelse(DFW$Grade_Group=="C",0,ifelse(DFW$Grade_Group=="D",0,ifelse(DFW$Grade_Group=="CR",0,1)))))
DFW$DDFW<-ifelse(DFW$Grade_Group=="A",0,ifelse(DFW$Grade_Group=="B",0,ifelse(DFW$Grade_Group=="C",0,ifelse(DFW$Grade_Group=="CR",0,1))))
names(DFW)[names(DFW)=="INSTRUCTOR1_NAME"] <- "instructor"
names(DFW)[names(DFW)=="FirstGeneration"] <- "firstgen"
names(DFW)[names(DFW)=="COURSE_ID"] <- "course"
DFW$courID <- paste(DFW$Subject,DFW$course,DFW$Section,DFW$TERM, sep='')
```

creating dummy variables
```{r}

DFW$firstgen <- ifelse(DFW$firstgen=="First Generation Student",1,0)

DFW$white <- ifelse(DFW$Ethnicity=="White",1,0)
DFW$black <- ifelse(DFW$Ethnicity=="Black/African American",1,0)
DFW$unknown <- ifelse(DFW$Ethnicity=="Unknown",1,ifelse(DFW$Ethnicity=="NULL",1,0))
DFW$asian <- ifelse(DFW$Ethnicity=="Asian",1,0)
DFW$mult_race <- ifelse(DFW$Ethnicity=="Two or More Races",1,0)
DFW$nonres <- ifelse(DFW$Ethnicity=="Non-Resident Alien",1,0)
DFW$pac_isl <- ifelse(DFW$Ethnicity=="Pacific Islander",1,0)
DFW$indian <- ifelse(DFW$Ethnicity=="American Indian/Alaskan Native",1,0)

DFW$Female <- ifelse(DFW$GenderLabel=="Male",0,1)

```

subset data
```{r}
DFW_phys <- DFW[DFW$Subject=="PHYS",]
DFW_math <- DFW[DFW$Subject=="MATH",]
DFW_math_phys <- DFW[DFW$Subject=="PHYS" | DFW$Subject=="MATH",]
DFW_202A <- DFW[DFW$Number=="202A",]
DFW_202B <- DFW[DFW$Number=="202B",]
DFW_204A <- DFW[DFW$Number=="204A",]
DFW_204B <- DFW[DFW$Number=="204B",]
DFW_204C <- DFW[DFW$Number=="204C",]
```

Models
```{r}
m1 <- (DFW ~ 1)
m1.5 <- (DFW ~ LA)
m2 <- (DFW ~ white)
m3 <- (DFW ~ white + firstgen)
m4 <- (DFW ~ white + firstgen + Female)
m5 <- (DFW ~ white + firstgen + Female + LA)
m6 <- (DFW ~ white*LA + firstgen*LA +Female*LA)

m1d <- (DDFW ~ 1)
m1.5d <- (DDFW ~ LA)
m2d <- (DDFW ~ white)
m3d <- (DDFW ~ white + firstgen)
m4d <- (DDFW ~ white + firstgen + Female)
m5d <- (DDFW ~ white + firstgen + Female + LA)
m6d <- (DDFW ~ white*LA + firstgen*LA +Female*LA)
```

running models - physics
```{r}
#p1 <- hglm(fixed = m1, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
#p1.5 <- hglm(fixed = m1.5, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
#p2 <- hglm(fixed = m2, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
#p3 <- hglm(fixed = m3, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
#p4 <- hglm(fixed = m4, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
#p5 <- hglm(fixed = m5, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
#p6 <- hglm(fixed = m6, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)

p1d <- hglm(fixed = m1d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
p1.5d <- hglm(fixed = m1.5d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
p2d <- hglm(fixed = m2d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
p3d <- hglm(fixed = m3d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
p4d <- hglm(fixed = m4d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
p5d <- hglm(fixed = m5d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)
p6d <- hglm(fixed = m6d, random = ~ 1|courID, data=DFW_phys, family = binomial(link = logit), calc.like=TRUE)

p5d202A <- hglm(fixed = m5d, random = ~ 1|courID, data=DFW_202A, family = binomial(link = logit), calc.like=TRUE)
p5d202B <- hglm(fixed = m5d, random = ~ 1|courID, data=DFW_202B, family = binomial(link = logit), calc.like=TRUE)
p5d204A <- hglm(fixed = m5d, random = ~ 1|courID, data=DFW_204A, family = binomial(link = logit), calc.like=TRUE)
p5d204B <- hglm(fixed = m5d, random = ~ 1|courID, data=DFW_204B, family = binomial(link = logit), calc.like=TRUE)
p5d204C <- hglm(fixed = m5d, random = ~ 1|courID, data=DFW_204C, family = binomial(link = logit), calc.like=TRUE)

p6d202A <- hglm(fixed = m6d, random = ~ 1|courID, data=DFW_202A, family = binomial(link = logit), calc.like=TRUE)
p6d202B <- hglm(fixed = m6d, random = ~ 1|courID, data=DFW_202B, family = binomial(link = logit), calc.like=TRUE)
p6d204A <- hglm(fixed = m6d, random = ~ 1|courID, data=DFW_204A, family = binomial(link = logit), calc.like=TRUE)
p6d204B <- hglm(fixed = m6d, random = ~ 1|courID, data=DFW_204B, family = binomial(link = logit), calc.like=TRUE)
p6d204C <- hglm(fixed = m6d, random = ~ 1|courID, data=DFW_204C, family = binomial(link = logit), calc.like=TRUE)
```


Model outputs - physics
```{r}
#summary(p1)
#summary(p1.5)
#summary(p2)
#summary(p3)
#summary(p4)
#summary(p5)
#summary(p6)

summary(p1d)
summary(p1.5d)
summary(p2d)
summary(p3d)
summary(p4d)
summary(p5d)
summary(p6d)

summary(p5d202A)
summary(p5d202B)
summary(p5d204A)
summary(p5d204B)
summary(p5d204C)

summary(p6d202A)
summary(p6d202B)
summary(p6d204A)
summary(p6d204B)
summary(p6d204C)
```

Probabilities - physics (https://sebastiansauer.github.io/convert_logit2prob/)
```{r}
logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

logit2prob(-1.5)
logit2prob(-1.5)
mean(DFW_phys$DFW)
```

cAIC - physics
```{r}
cAIC(p1)
```

running models - math & physics
```{r}
mp1 <- hglm(fixed = m1, random = ~ 1|courseID, data=DFW_math_phys, family = binomial(link = logit))
mp2 <- hglm(fixed = m2, random = ~ 1|courseID, data=DFW_math_phys, family = binomial(link = logit))
mp3 <- hglm(fixed = m3, random = ~ 1|courseID, data=DFW_math_phys, family = binomial(link = logit))
mp4 <- hglm(fixed = m4, random = ~ 1|courseID, data=DFW_math_phys, family = binomial(link = logit))
mp5 <- hglm(fixed = m5, random = ~ 1|courseID, data=DFW_math_phys, family = binomial(link = logit))
mp6 <- hglm(fixed = m6, random = ~ 1|courseID, data=DFW_math_phys, family = binomial(link = logit))
```

Model outputs - physics
```{r}
summary(mp1)
summary(mp2)
summary(mp3)
summary(mp4)
summary(mp5)
summary(mp6)
```
